<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Investment Calculator Hub</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
      }
      .title {
        color: #d32f2f;
        font-size: 24px;
        margin-bottom: 5px;
      }
      .calculator-links {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .calculator-card {
        background-color: #f8f8f8;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        text-decoration: none;
        color: #333;
        transition: transform 0.2s;
      }
      .calculator-card:hover {
        transform: translateY(-5px);
      }
      .calculator-title {
        color: #d32f2f;
        font-size: 18px;
        margin-bottom: 10px;
      }
      .calculator-description {
        color: #666;
        font-size: 14px;
      }
      #phtClock {
        font-weight: bold;
        font-size: 1.2em;
        margin-bottom: 20px;
        text-align: center;
      }
      /* New styles for real-time earnings counter */
      label {
        display: block;
        margin-top: 10px;
      }
      input {
        margin-left: 10px;
      }
      #realTimeResults {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 10px;
        font-family: monospace;
        background: #f9f9f9;
      }
      .earnings-section {
        margin-top: 40px;
        padding: 20px;
        background-color: #f8f8f8;
        border-radius: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1 class="title">Investment Calculator Hub</h1>
      </div>

      <div id="phtClock">Loading Philippine Time...</div>

      <div class="calculator-links">
        <a href="/tenMinuteCompound.html" class="calculator-card">
          <h2 class="calculator-title">10-Minute Compound Interest</h2>
          <p class="calculator-description">Simulate a year of growth in just 12 minutes with auto-reinvestment</p>
        </a>
      </div>

      <!-- Real-time Earnings Counter Section -->
      <div class="earnings-section">
        <h2>Real-Time Earnings Counter (Philippine Time)</h2>

        <form id="depositForm">
          <label>
            Current Money:
            <input type="number" id="currentMoneyInput" required min="0" step="0.01" />
          </label>
          <label>
            Deposit Amount:
            <input type="number" id="amountInput" required min="0.01" step="0.01" />
          </label>
          <label>
            Start Date:
            <input type="date" id="dateInput" required />
          </label>
          <button type="submit" style="margin-top: 15px">Start Earning Counter</button>
        </form>

        <h3>Available Balance:</h3>
        <p id="availableBalanceDisplay"></p>

        <h3>Real-Time Earnings (per minute, synced to PHT clock):</h3>
        <div id="realTimeResults"></div>
      </div>
    </div>

    <script>
      function getPHTNow() {
        const now = new Date();
        const options = {
          timeZone: "Asia/Manila",
          hour12: false,
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        };
        const formatter = new Intl.DateTimeFormat("en-PH", options);
        const parts = formatter.formatToParts(now);
        let y, m, d, h, min, s;
        for (const part of parts) {
          if (part.type === "year") y = part.value;
          if (part.type === "month") m = part.value;
          if (part.type === "day") d = part.value;
          if (part.type === "hour") h = part.value;
          if (part.type === "minute") min = part.value;
          if (part.type === "second") s = part.value;
        }
        return new Date(`${y}-${m}-${d}T${h}:${min}:${s}`);
      }

      function updatePHTClock() {
        const nowPHT = getPHTNow();
        document.getElementById(
          "phtClock"
        ).textContent = `Philippine Time: ${nowPHT.toLocaleTimeString("en-PH", {
          timeZone: "Asia/Manila",
        })}`;
      }

      setInterval(updatePHTClock, 1000);
      updatePHTClock();

      document.getElementById("depositForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const currentMoney = parseFloat(document.getElementById("currentMoneyInput").value);
        const amount = parseFloat(document.getElementById("amountInput").value);
        const dateStr = document.getElementById("dateInput").value;

        const balanceDisplay = document.getElementById("availableBalanceDisplay");
        const realTimeResults = document.getElementById("realTimeResults");

        balanceDisplay.textContent = "";
        realTimeResults.innerHTML = "";

        if (amount > currentMoney) {
          alert("Deposit amount cannot be more than the money you currently have.");
          return;
        }

        let response;
        try {
          response = await fetch("/generate-dates", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ currentMoney, amount }),
          });
        } catch (err) {
          alert("Failed to connect to server.");
          return;
        }

        if (!response.ok) {
          const error = await response.json();
          alert(`Server error: ${error.error}`);
          return;
        }

        const { availableBalance, interestRate } = await response.json();

        const totalMinutes = 262080; // ~6 months
        const ratePerPeriod = interestRate / 100;
        const ratePerMinute = Math.pow(1 + ratePerPeriod, 1 / totalMinutes) - 1;

        let startDate = getPHTNow();
        let totalEarned = 0;
        let previousAmount = amount;
        let lastTransferMinute = 0;

        function addLog(message) {
          const div = document.createElement("div");
          div.textContent = message;
          realTimeResults.appendChild(div);
          realTimeResults.scrollTop = realTimeResults.scrollHeight;
        }

        function updateEarnings() {
          const now = getPHTNow();
          const elapsedMinutes = Math.floor(
            (now.getTime() - startDate.getTime()) / 60000
          );
          if (elapsedMinutes < 1) return;

          const currentAmount = amount * Math.pow(1 + ratePerMinute, elapsedMinutes);
          const earnedThisMinute = currentAmount - previousAmount;
          totalEarned += earnedThisMinute;
          previousAmount = currentAmount;

          addLog(
            `Minute ${elapsedMinutes}: ${now.toLocaleString("en-PH", {
              timeZone: "Asia/Manila",
            })} — Earned this minute: ₱${earnedThisMinute.toFixed(
              6
            )} — Total Untransferred Earnings: ₱${totalEarned.toFixed(6)}`
          );

          const minutesSinceLastTransfer = elapsedMinutes - lastTransferMinute;
          if (minutesSinceLastTransfer >= 2) {
            const tax = totalEarned * 0.2;
            const netEarned = totalEarned - tax;
            availableBalance += netEarned;

            balanceDisplay.textContent = `₱${availableBalance.toFixed(2)}`;
            addLog(
              `>> HOURLY TRANSFER at Minute ${elapsedMinutes}: ₱${netEarned.toFixed(
                2
              )} added to available balance with 20% tax (₱${tax.toFixed(2)} deducted)`
            );

            totalEarned = 0;
            lastTransferMinute = elapsedMinutes;
          }
        }

        function msUntilNextMinute() {
          const now = getPHTNow();
          return (60 - now.getSeconds()) * 1000 - now.getMilliseconds();
        }

        if (window.earningInterval) clearInterval(window.earningInterval);

        addLog(
          `Minute 0: ${getPHTNow().toLocaleString("en-PH", {
            timeZone: "Asia/Manila",
          })} — Initial deposit ₱${amount.toFixed(
            2
          )} — Interest Rate: ${interestRate.toFixed(2)}%`
        );
        balanceDisplay.textContent = `₱${availableBalance.toFixed(2)}`;

        setTimeout(() => {
          updateEarnings();
          window.earningInterval = setInterval(updateEarnings, 60000);
        }, msUntilNextMinute());
      });
    </script>
  </body>
</html>
